<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>SSH Defence - Hello, world! I'm Gxxang Liu</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Hello, world! I'm Gxxang Liu" property="og:site_name">
  
    <meta content="SSH Defence" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
" property="og:description">
  
  
    <meta content="http://localhost:4000/drafts/ssh-protection/" property="og:url">
  
  
    <meta content="2019-07-03T00:00:00+08:00" property="article:published_time">
    <meta content="http://localhost:4000/about/" property="article:author">
  
  
    <meta content="http://localhost:4000/flexible-jekyll/assets/img/hacker.jpg" property="og:image">
  
  
  
    
    <meta content="SSH" property="article:tag">
    
    <meta content="endlessh" property="article:tag">
    
  

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">
  
    <meta name="twitter:title" content="SSH Defence">
  
  
    <meta name="twitter:url" content="http://localhost:4000/drafts/ssh-protection/">
  
  
    <meta name="twitter:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">
  
  
    <meta name="twitter:image:src" content="http://localhost:4000/flexible-jekyll/assets/img/hacker.jpg">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/flexible-jekyll/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/flexible-jekyll/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/flexible-jekyll/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/flexible-jekyll/assets/img/favicon/apple-touch-icon-144x144.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/flexible-jekyll/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/flexible-jekyll/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/flexible-jekyll/"><img src="/flexible-jekyll/assets/img/avatar.png" alt="Gaoang Liu"></a>
      </div>
      <div class="author-name">Gaoang Liu</div>
      <p>I am machine-learning lover focusing on Deep Learning. Always hungry to keep learning.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        <!-- 
          <li><a href="https://twitter.com/artemsheludko_" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://facebook.com/" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
         -->
        
          <li class="github"><a href="http://github.com/ssrzz" target="_blank"><i class="fa fa-github"></i></a></li>
        
        <!-- 
          <li class="linkedin"><a href="https://in.linkedin.com/" target="_blank"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li>
         -->
        
          <li class="email"><a href="mailto:ssrzz@pm.me"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <div class="copyright">
      <p>2019 &copy; Gaoang Liu</p>
    </div>
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<article class="article-page">
  <div class="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/flexible-jekyll/assets/img/hacker.jpg alt="SSH Defence">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">SSH Defence</h1>
        <div class="page-date"><span>2019, Jul 03&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <p><code class="highlighter-rouge">lastb</code>  查看失败的SSH登录尝试历史，如果一段时间内出现一连段的相同或相近的IP，那么恭喜，这台服务器被盯上了。</p>

<p>注： 防护工具也只是工具，不能保护服务器100%安全。 保护好服务器，首先要排除错误选项，包括但不限于： <strong>弱密码、默认端口、不重视异常登录</strong>.</p>

<h2 id="endlessh">Endlessh</h2>

<p><a href="https://github.com/skeeto/endlessh">Endlessh</a> is an SSH tarpit <a href="https://nullprogram.com/blog/2019/03/22/">that <em>very</em> slowly sends an endless, random SSH banner </a>.</p>

<p>将计就计，欺骗攻击者，使其客户端(攻击工具或程序) 长时间卡住(数小时或者数日)。</p>

<h3 id="usage">Usage</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Usage</span><span class="p">:</span> <span class="n">endlessh</span> <span class="p">[</span><span class="o">-</span><span class="n">vh</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span> <span class="n">MS</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">f</span> <span class="n">CONFIG</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">l</span> <span class="n">LEN</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">m</span> <span class="n">LIMIT</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">p</span> <span class="n">PORT</span><span class="p">]</span>
  <span class="o">-</span><span class="mi">4</span>        <span class="n">Bind</span> <span class="n">to</span> <span class="n">IPv4</span> <span class="n">only</span>
  <span class="o">-</span><span class="mi">6</span>        <span class="n">Bind</span> <span class="n">to</span> <span class="n">IPv6</span> <span class="n">only</span>
  <span class="o">-</span><span class="n">d</span> <span class="n">INT</span>    <span class="n">Message</span> <span class="n">millisecond</span> <span class="n">delay</span> <span class="p">[</span><span class="mi">10000</span><span class="p">]</span>
  <span class="o">-</span><span class="n">f</span>        <span class="n">Set</span> <span class="ow">and</span> <span class="n">load</span> <span class="n">config</span> <span class="nb">file</span> <span class="p">[</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">endlessh</span><span class="o">/</span><span class="n">config</span><span class="p">]</span>
  <span class="o">-</span><span class="n">h</span>        <span class="n">Print</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">exit</span>
  <span class="o">-</span><span class="n">l</span> <span class="n">INT</span>    <span class="n">Maximum</span> <span class="n">banner</span> <span class="n">line</span> <span class="n">length</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="mi">255</span><span class="p">)</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span>
  <span class="o">-</span><span class="n">m</span> <span class="n">INT</span>    <span class="n">Maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="n">clients</span> <span class="p">[</span><span class="mi">4096</span><span class="p">]</span>
  <span class="o">-</span><span class="n">p</span> <span class="n">INT</span>    <span class="n">Listening</span> <span class="n">port</span> <span class="p">[</span><span class="mi">2222</span><span class="p">]</span>
  <span class="o">-</span><span class="n">v</span>        <span class="n">Print</span> <span class="n">diagnostics</span> <span class="n">to</span> <span class="n">standard</span> <span class="n">output</span> <span class="p">(</span><span class="n">repeatable</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="tips">Tips</h3>

<ul>
  <li>
    <p>爆破手通常会选择直接尝试端口22(多数机器的默认端口，且很多用户未更改)，所以使用endless前先将端口改成一个好记但不常用的端口，比如：8964</p>
  </li>
  <li>
    <p>Endlessh 默认监听2222，为了欺骗攻击者，手动指定监听22端口</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">endlessh</span> <span class="o">-</span><span class="n">p</span> <span class="mi">22</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>使用参数 <code class="highlighter-rouge">-v</code> 保持脚本运行日志 <code class="highlighter-rouge">endlessh -v -p 22 &gt; end.log</code></p>
  </li>
</ul>

<h2 id="fail2ban">Fail2ban</h2>

<p><a href="https://github.com/fail2ban/fail2ban">Fail2ban</a> 基于auth日志文件工作，默认情况下它会扫描所有 auth 日志文件，如 <code class="highlighter-rouge">/var/log/auth.log</code>、<code class="highlighter-rouge">/var/log/apache/access.log</code> 等，并禁止带有恶意标志的IP，比如密码失败太多。</p>

<p>Fail2ban 可用于在指定的时间内拒绝 IP 地址，可以发送邮件通知。 Fail2ban能够降低错误认证尝试的速度，但是它不能消除弱认证带来的风险。</p>

<h3 id="安装">安装</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">git</span> <span class="nb">clone</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">fail2ban</span><span class="p">.</span><span class="nf">git</span>
<span class="n">cd</span> <span class="n">fail2ban</span>
<span class="n">sudo</span> <span class="n">python</span> <span class="n">setup</span><span class="p">.</span><span class="nf">py</span> <span class="n">install</span> <span class="p">,</span> <span class="c1">## or </span>

<span class="c1"># For Debian/Ubuntu</span>
<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">fail2ban</span>
<span class="c1"># For CentOS 6+</span>
<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">fail2ban</span>
</code></pre></div></div>

<h3 id="配置">配置</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cp</span> <span class="sr">/etc/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">jail</span><span class="p">.</span><span class="nf">conf</span> <span class="sr">/etc/</span><span class="n">fail2ban</span><span class="o">/</span><span class="n">local</span><span class="p">.</span><span class="nf">conf</span>

<span class="c1"># emacs /etc/fail2ban/local.conf</span>
<span class="p">[</span><span class="no">DEFAULT</span><span class="p">]</span>
<span class="n">ignoreip</span> <span class="o">=</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">8</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span><span class="o">/</span><span class="mi">24</span>
<span class="n">bantime</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">findtime</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">maxretry</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># SSH servers</span>
<span class="p">[</span><span class="n">sshd</span><span class="p">]</span>
<span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">ssh</span>
<span class="n">logpath</span> <span class="o">=</span> <span class="sx">%(sshd_log)</span><span class="n">s</span>
<span class="n">backend</span> <span class="o">=</span> <span class="sx">%(sshd_backend)</span><span class="n">s</span>
</code></pre></div></div>

<ol>
  <li>不要直接操作主配置文件 <code class="highlighter-rouge">jail.conf</code>，文件包含一组预定义的过滤器。只要有新的更新，所有配置都会被重置。</li>
  <li>参数
    <ul>
      <li><code class="highlighter-rouge">ignoreip</code> 忽略特定IP</li>
      <li><code class="highlighter-rouge">bantime</code> 被禁时间(单位 second)</li>
      <li><code class="highlighter-rouge">maxtry</code> 是主机被禁止之前的失败次数</li>
      <li><code class="highlighter-rouge">findtime</code> 如果在最近 <code class="highlighter-rouge">findtime</code> 秒期间已经发生了 <code class="highlighter-rouge">maxretry</code> 次重试，则主机会被禁止</li>
    </ul>
  </li>
</ol>

<p>更改配置后 <code class="highlighter-rouge">systemctl restart fail2ban.service</code>重启fail2ban.</p>

<p><code class="highlighter-rouge">fail2ban-client status ssh</code>  获取禁止的 IP ， <code class="highlighter-rouge">fail2ban-client set ssh unbanip 1.2.3.4</code>来释放被ban掉的IP.</p>


      <div class="page-footer">
        <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=SSH Defence&url=http://localhost:4000/drafts/ssh-protection/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=http://localhost:4000/drafts/ssh-protection/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=http://localhost:4000/drafts/ssh-protection/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div>
        <div class="page-tag">
          
            <a href="/flexible-jekyll/tags#SSH" class="tag">&#35; SSH</a>
          
            <a href="/flexible-jekyll/tags#endlessh" class="tag">&#35; endlessh</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//ssrzz.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->

</body>
</html>
